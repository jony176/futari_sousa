<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ•ã‚¿ãƒªã‚½ã‚¦ã‚µï¼šã‚­ãƒ£ãƒ©ã‚·ä½œæˆï¼ˆè¤‡æ•°ä¿å­˜ï¼åˆ‡æ›¿ï¼ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰</title>
  <style>
    :root { --bd:#e6e6e6; --mut:#666; --bg:#fafafa; }
    body { font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 18px; line-height: 1.55; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .hint { margin: 0 0 14px; color: var(--mut); }
    .wrap { max-width: 1100px; display: grid; gap: 14px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid var(--bd); border-radius: 10px; padding: 12px; background: white; }
    .card h2 { margin:0 0 10px; font-size: 16px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 880px){ .grid2{ grid-template-columns:1fr; } }

    label { display:block; font-size: 13px; color:#222; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%; box-sizing: border-box; padding: 9px 10px; border: 1px solid var(--bd);
      border-radius: 8px; background: white; font-size: 14px;
    }
    textarea { min-height: 86px; resize: vertical; }

    .seg { display:flex; gap: 8px; flex-wrap: wrap; }
    .seg label { display:flex; align-items:center; gap: 6px; padding: 7px 10px; border:1px solid var(--bd); border-radius:999px; cursor:pointer; background: var(--bg); }
    .seg input { margin:0; }

    .muted { color: var(--mut); font-size: 12px; }
    .pill { display:inline-flex; align-items:center; gap: 8px; padding: 6px 10px; border:1px solid var(--bd); border-radius: 999px; background: var(--bg); font-size: 12px; }
    .tag { font-size: 12px; color: #333; padding: 4px 8px; border:1px solid var(--bd); border-radius: 999px; display:inline-block; background: var(--bg); }

    .actions { font-size: 13px; }
    .actions .a { margin: 6px 0; padding: 8px 10px; border: 1px solid var(--bd); border-radius: 10px; background: var(--bg); }

    .btns { display:flex; gap: 10px; flex-wrap:wrap; }
    button {
      border: 1px solid var(--bd); background: white; border-radius: 10px;
      padding: 9px 10px; cursor:pointer; font-size: 14px;
    }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button.small { padding: 7px 9px; font-size: 12px; border-radius: 999px; }
    button.danger { border-color:#c33; color:#c33; }
    button:active { transform: translateY(1px); }
    .hide { display:none !important; }

    details { border:1px solid var(--bd); border-radius: 10px; padding: 10px; background: white; }
    details > summary { cursor:pointer; font-weight:600; }

    .field { display:grid; grid-template-columns: 1fr auto; gap: 8px; align-items:end; }
    .field > div { min-width: 0; }

    /* skills */
    .slots { display:grid; gap: 10px; }
    .slotGroup { border:1px dashed var(--bd); border-radius: 10px; padding: 10px; background: #fff; }
    .slotGroup h3 { margin:0 0 8px; font-size: 14px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;}
    .slotRow { display:grid; grid-template-columns: 170px 1fr; gap: 10px; align-items:center; margin: 8px 0; }
    @media (max-width: 620px){ .slotRow{ grid-template-columns: 1fr; } }
    .twoStage { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 620px){ .twoStage{ grid-template-columns: 1fr; } }

    /* preview */
    pre.preview {
      white-space: pre-wrap; word-break: break-word; background:#0b1020; color:#e8eefc;
      padding: 12px; border-radius: 10px; border: 1px solid #1e2a55; font-size: 13px;
      max-height: 520px; overflow:auto;
    }
    .statusbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>
  <h1>ãƒ•ã‚¿ãƒªã‚½ã‚¦ã‚µï¼šã‚­ãƒ£ãƒ©ã‚·ä½œæˆï¼ˆè¤‡æ•°ã‚­ãƒ£ãƒ©ï¼ä¿å­˜ï¼åˆ‡æ›¿ï¼‰</h1>
  <p class="hint">
    âœ… è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚’ä½œã£ã¦ <b>ä¿å­˜â†’ä¸€è¦§ã§åˆ‡æ›¿</b> ã§ãã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®LocalStorageã«ä¿å­˜ï¼‰ã€‚<br>
    âœ… ã•ã‚‰ã« <b>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</b>ï¼ˆJSONï¼‰ã‚‚å¯èƒ½ã€‚
  </p>

  <div class="wrap">

    <!-- ä¿å­˜ï¼åˆ‡æ›¿ -->
    <div class="card">
      <h2>ä¿å­˜ãƒ»åˆ‡æ›¿</h2>
      <div class="grid2">
        <div>
          <label>ä¿å­˜æ¸ˆã¿ã‚­ãƒ£ãƒ©</label>
          <select id="charSelect"></select>
          <div class="muted" id="saveMeta" style="margin-top:6px;">â€”</div>
        </div>

        <div>
          <label>æ“ä½œ</label>
          <div class="btns">
            <button class="primary" id="btnSave">ğŸ’¾ ä¸Šæ›¸ãä¿å­˜</button>
            <button id="btnSaveAs">â• æ–°è¦ã¨ã—ã¦ä¿å­˜</button>
            <button id="btnNew">ğŸ†• æ–°è¦ä½œæˆï¼ˆæœªä¿å­˜ï¼‰</button>
            <button class="danger" id="btnDelete">ğŸ—‘ å‰Šé™¤</button>
          </div>

          <div class="btns" style="margin-top:10px">
            <button id="btnExportOne">â¬‡ï¸ ã“ã®ã‚­ãƒ£ãƒ©ã‚’æ›¸ãå‡ºã—</button>
            <button id="btnExportAll">â¬‡ï¸ å…¨ã‚­ãƒ£ãƒ©ã‚’æ›¸ãå‡ºã—</button>
            <button id="btnImport">â¬†ï¸ JSONã‚’èª­ã¿è¾¼ã¿</button>
            <input id="importFile" type="file" accept="application/json" class="hide" />
          </div>

          <div class="statusbar" style="margin-top:10px">
            <label class="pill" style="cursor:pointer;">
              <input id="autoSave" type="checkbox" style="margin-right:6px;"> è‡ªå‹•ä¿å­˜
            </label>
            <span class="pill" id="status">çŠ¶æ…‹ï¼šæœªä¿å­˜</span>
          </div>
          <p class="muted">â€»è‡ªå‹•ä¿å­˜ONã ã¨ã€å…¥åŠ›å¤‰æ›´ã®ãŸã³ã«ã€Œé¸æŠä¸­ã‚­ãƒ£ãƒ©ã€ã‚’ä¸Šæ›¸ãã—ã¾ã™ï¼ˆæœªé¸æŠã®æ–°è¦ä½œæˆä¸­ã¯ä¿å­˜ã—ã¾ã›ã‚“ï¼‰ã€‚</p>
        </div>
      </div>
    </div>

    <!-- ç¨®åˆ¥ -->
    <div class="card">
      <h2>0) ã‚­ãƒ£ãƒ©ç¨®åˆ¥</h2>
      <div class="row">
        <div class="seg">
          <label><input type="radio" name="role" value="detective" checked> æ¢åµ</label>
          <label><input type="radio" name="role" value="assistant"> åŠ©æ‰‹</label>
        </div>
        <span class="pill" id="rulePill">æŠ€èƒ½ãƒ«ãƒ¼ãƒ«ï¼šâ€”</span>
      </div>

      <div class="btns" style="margin-top:10px">
        <button class="primary" id="btnRandomSkills">ğŸ² æŠ€èƒ½ã ã‘ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button id="btnResetSkills">â†© æŠ€èƒ½ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <h2>1) åŸºæœ¬æƒ…å ±</h2>

        <div class="grid2">
          <div class="field">
            <div>
              <label>åå‰ï¼ˆè‡ªç”±è¨˜è¼‰ï¼‰</label>
              <input id="name" type="text" placeholder="ä¾‹ï¼šæ±é›² æ’ä¸€ / Sherlock Holmes ãªã©" />
            </div>
            <button class="small" id="randName" title="åå‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>

          <div class="field">
            <div>
              <label>å½åï¼ˆä»»æ„ï¼‰</label>
              <input id="alias" type="text" placeholder="ä¾‹ï¼šã€ä¾¿åˆ©å±‹ã€ / ã‚¢ãƒ³ãƒã‚¦ãƒ³ ãªã©" />
            </div>
            <button class="small" id="randAlias" title="å½åã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>

          <div class="field">
            <div>
              <label>å¹´é½¢ï¼ˆè‡ªç”±ï¼‰</label>
              <input id="age" type="number" min="0" placeholder="ä¾‹ï¼š27" />
            </div>
            <button class="small" id="randAge" title="å¹´é½¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>

          <div class="field">
            <div>
              <label>èº«é•·ï¼ˆè¡¨ï¼‰</label>
              <select id="height"></select>
            </div>
            <button class="small" id="randHeight" title="èº«é•·ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>

          <div class="field">
            <div>
              <label>ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ï¼ˆè‡ªç”±è¨˜è¼‰ãƒ»ç‰¹å¾´1ã¤ï¼‰</label>
              <input id="fashion" type="text" placeholder="ä¾‹ï¼šé»’ã‚¹ãƒ¼ãƒ„ï¼æ´¾æ‰‹ãƒ”ã‚¢ã‚¹ï¼ç™½è¡£ ãªã©" />
            </div>
            <button class="small" id="randFashion" title="ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>

          <div class="field">
            <div>
              <label>è·æ¥­ï¼ˆè‡ªç”±è¨˜è¼‰ï¼‰</label>
              <input id="job" type="text" placeholder="ä¾‹ï¼šå¤§å­¦è¬›å¸«ï¼ãƒ•ãƒªãƒ¼ã‚¿ãƒ¼ï¼åˆ‘äº‹ ãªã©" />
            </div>
            <button class="small" id="randJob" title="è·æ¥­ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>

          <div class="field">
            <div>
              <label>å¥½ããªã‚‚ã®ï¼ˆè‡ªç”±è¨˜è¼‰ãƒ»1ã¤ï¼‰</label>
              <input id="like" type="text" placeholder="ä¾‹ï¼šçŒ«ï¼è¬ï¼ã‚¸ãƒ£ãƒ³ã‚¯ãƒ•ãƒ¼ãƒ‰ ãªã©" />
            </div>
            <button class="small" id="randLike" title="å¥½ããªã‚‚ã®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>

          <div class="field">
            <div>
              <label>å«Œã„ãªã‚‚ã®ï¼ˆè‡ªç”±è¨˜è¼‰ãƒ»1ã¤ï¼‰</label>
              <input id="dislike" type="text" placeholder="ä¾‹ï¼šæ¨©åŠ›ï¼é›¨ï¼æ²ˆé»™ ãªã©" />
            </div>
            <button class="small" id="randDislike" title="å«Œã„ãªã‚‚ã®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
          </div>
        </div>

        <div id="detectiveOnlyBasics" style="margin-top:12px" class="field">
          <div>
            <label>ç•°å¸¸ãªç™–ï¼ˆæ¢åµã®ã¿ï¼è‡ªç”±è¨˜è¼‰ï¼‰</label>
            <input id="weirdHabit" type="text" placeholder="ä¾‹ï¼šå¦™ã§ã™ã­â€¦ã¨å¿…ãšè¨€ã†ï¼å‹æ‰‹ã«é‘‘è­˜ã‚’å§‹ã‚ã‚‹ ãªã©" />
          </div>
          <button class="small" id="randWeird" title="ç•°å¸¸ãªç™–ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
        </div>

        <div style="margin-top:12px">
          <label>è‡ªç”±ãƒ¡ãƒ¢</label>
          <textarea id="memo" placeholder="è‡ªç”±è¨˜è¿°ï¼šå£ç™–/äººé–“é–¢ä¿‚/ãŸã¾ã‚Šå ´/äº‹ä»¶ã«å¯¾ã™ã‚‹å§¿å‹¢ãªã©"></textarea>
        </div>
      </div>

      <div class="card">
        <h2>2) ã‚¯ãƒ©ã‚¹ï¼èƒŒæ™¯ï¼ˆã‚¯ãƒ©ã‚¹é€£å‹•ï¼‰</h2>

        <div id="detectiveClassBox">
          <label>æ¢åµã®ã‚¯ãƒ©ã‚¹</label>
          <div class="seg" style="margin-top:6px">
            <label><input type="radio" name="dclass" value="blood" checked> é‹å‘½ã®è¡€çµ±</label>
            <label><input type="radio" name="dclass" value="talent"> å¤©æ€§ã®æ‰èƒ½</label>
            <label><input type="radio" name="dclass" value="mania"> ãƒãƒ‹ã‚¢</label>
          </div>
        </div>

        <div id="assistantClassBox" class="hide">
          <label>åŠ©æ‰‹ã®ã‚¯ãƒ©ã‚¹</label>
          <div class="seg" style="margin-top:6px">
            <label><input type="radio" name="aclass" value="justice" checked> æ­£ç¾©ã®äºº</label>
            <label><input type="radio" name="aclass" value="passion"> æƒ…ç†±ã®äºº</label>
            <label><input type="radio" name="aclass" value="involved"> å·»ãè¾¼ã¾ã‚Œã®äºº</label>
          </div>
        </div>

        <div class="field" style="margin-top:12px">
          <div>
            <label>èƒŒæ™¯ï¼ˆã‚¯ãƒ©ã‚¹é€£å‹•å€™è£œï¼‰</label>
            <select id="background"></select>
          </div>
          <button class="small" id="randBackground" title="èƒŒæ™¯ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
        </div>

        <div style="margin-top:12px">
          <h3 style="margin:0 0 6px; font-size:14px;">å›ºå®šæŠ€èƒ½ï¼ˆè‡ªå‹•ä»˜ä¸ï¼‰</h3>
          <div class="muted" id="fixedSkillsBox">â€”</div>
        </div>

        <div style="margin-top:12px">
          <h3 style="margin:0 0 6px; font-size:14px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå‹•ä»˜ä¸ï¼‰</h3>
          <div class="actions" id="actionsBox"></div>
        </div>

        <div id="assistantMental" class="hide" style="margin-top:12px">
          <h3 style="margin:0 0 6px; font-size:14px;">ãƒ¡ãƒ³ã‚¿ãƒ«ï¼ˆåŠ©æ‰‹ã®ã¿ï¼‰</h3>
          <div class="row">
            <span class="pill">ä½™è£•ï¼š<b>0</b></span>
            <span class="pill">å¿ƒåŠ´ï¼š<b>0</b>ï¼ˆ3ã§ãƒ­ã‚¹ãƒˆï¼‰</span>
          </div>
        </div>

        <details id="guestBox" class="hide" style="margin-top:12px">
          <summary>ã‚²ã‚¹ãƒˆï¼ˆåŠ©æ‰‹ã®ã¿ï¼šä½œæˆæ®µéšã§1äººï¼‰</summary>
          <div class="grid2" style="margin-top:10px">
            <div class="field">
              <div>
                <label>ã‚²ã‚¹ãƒˆåï¼ˆè‡ªç”±è¨˜è¼‰ï¼‰</label>
                <input id="guestName" type="text" placeholder="ä¾‹ï¼šå°å³¶ ç²å¥ˆ / Rachel" />
              </div>
              <button class="small" id="randGuestName" title="ã‚²ã‚¹ãƒˆåã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
            </div>

            <div class="field">
              <div>
                <label>ã‚²ã‚¹ãƒˆæŠ€èƒ½ï¼ˆ1ã¤ï¼‰</label>
                <select id="guestSkill"></select>
              </div>
              <button class="small" id="randGuestSkill" title="ã‚²ã‚¹ãƒˆæŠ€èƒ½ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
            </div>

            <div class="field" style="grid-column:1/-1">
              <div>
                <label>é–¢ä¿‚ï¼ˆè‡ªç”±è¨˜è¼‰ï¼‰</label>
                <input id="guestRelation" type="text" placeholder="ä¾‹ï¼šå¹¼é¦´æŸ“ï¼æˆ¦å‹ï¼è…ã‚Œç¸ ãªã©" />
              </div>
              <button class="small" id="randGuestRelation" title="é–¢ä¿‚ã‚’ãƒ©ãƒ³ãƒ€ãƒ ">ğŸ²</button>
            </div>
          </div>
        </details>

        <details style="margin-top:12px">
          <summary>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¬„ï¼ˆä½œæˆæ™‚ã¯ç©ºã§ã‚‚OKï¼‰</summary>
          <div class="grid2" style="margin-top:10px">
            <div><label>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®åå‰</label><input id="partnerName" type="text"></div>
            <div><label>å‘¼ã³å</label><input id="partnerCall" type="text"></div>
            <div><label>æ°—ã«å…¥ã£ãŸã¨ã“ã‚</label><input id="partnerLike" type="text"></div>
            <div><label>æ°—ã«å…¥ã‚‰ãªã„ã¨ã“ã‚</label><input id="partnerDislike" type="text"></div>
          </div>
        </details>
      </div>
    </div>

    <div class="card">
      <h2>3) æŠ€èƒ½ï¼ˆã‚¹ãƒ­ãƒƒãƒˆï¼è‡ªç”±æ ã¯2æ®µï¼‰</h2>
      <p class="muted" id="skillsHelp">â€”</p>
      <div class="slots" id="slotsBox"></div>
      <p class="muted">â€»åŒåæŠ€èƒ½ã¯é‡è¤‡å–å¾—ä¸å¯ã€‚æ—¢ã«é¸ã°ã‚Œã¦ã„ã‚‹æŠ€èƒ½ã¯ä»–ã‚¹ãƒ­ãƒƒãƒˆå€™è£œã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™ã€‚</p>
    </div>

    <div class="card">
      <h2>4) ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰</h2>
      <pre class="preview" id="preview">ï¼ˆã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</pre>
      <div class="btns" style="margin-top:10px">
        <button id="btnCopy">ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <p class="muted">â€»ã‚³ãƒ”ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã«ã‚ˆã‚Šå¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯æ‰‹å‹•é¸æŠã§OKã€‚</p>
    </div>

  </div>

<script>
/** ===================== ä¿å­˜ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ===================== **/
const STORAGE_KEY = "futarisousa_chars_v1";
const STORAGE_UI_KEY = "futarisousa_ui_v1"; // autosave, lastSelectedId
function nowIso(){ return new Date().toISOString(); }
function newId(){ return "c_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36); }

function loadDB(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}
function saveDB(db){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
}
function loadUI(){
  try {
    const raw = localStorage.getItem(STORAGE_UI_KEY);
    if (!raw) return { autoSave:false, lastSelectedId:"" };
    const obj = JSON.parse(raw);
    return { autoSave:!!obj.autoSave, lastSelectedId: obj.lastSelectedId||"" };
  } catch { return { autoSave:false, lastSelectedId:"" }; }
}
function saveUI(ui){
  localStorage.setItem(STORAGE_UI_KEY, JSON.stringify(ui));
}
function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** ===================== ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ©ãƒ³ãƒ€ãƒ å€™è£œï¼‰ ===================== **/
const lastNames = ["ä½è—¤","å‰ç”°","å°å³¶","æŸ´ç”°","ç§‹å±±","æ¸¡è¾º","éˆ´æœ¨","æœ¨æ‘","ä½ã€…æœ¨","å±±å´","æ£®","ç”°ä¸­","é•·è°·å·","å¤ªç”°","è¥¿æ‘","ä¼Šè—¤","ä¸Šç”°","è—¤åŸ","å°æ—","å¤§è¥¿","é«˜æ©‹","çš‡","å®‰è—¤","æ‘ä¸Š","çŸ³ç”°","é–¢","è’äº•","å°é³¥éŠ","ä¸­å·","æ˜Ÿé‡","æ¦æœ¬","é£¯ç”°","å››å­£","æ‰æœ¬","é¦¬å ´","åºƒç€¬","é‚£é ˆ","å²©ç”°","æ—©å·","æ±é›²","æ°´é‡","ä¸–ç•Œ","æš","å¤©é‡","å €","å®‡ç”°å·","è¥¿å±±","è§’ç”°","é¡","éŒç”°","å°å€‰","å²¡","å‚ç”°","é³³","å¤§å·","æ­¦äº•","å°ç¬ åŸ","èŠ¥","è©é‡","æ‰‹å¡š","æ§","è‡¼äº•","å·½","ãƒ¢ãƒªã‚¢ãƒ¼ãƒ†ã‚£","ãƒ›ãƒ¼ãƒ ã‚º","ãƒ¯ãƒˆã‚¹ãƒ³","ã‚¢ãƒ‰ãƒ©ãƒ¼"];
const firstNames = ["æ¶¼ä»‹","ã²ã‚ˆã‚Š","ç©º","ç´éŸ³","ç«œ","ã•ãã‚‰","æ™ºä¹Ÿ","ç¾ä¹Ÿ","å¤§å’Œ","ç¾æœˆ","å„ª","æ","å¿«äºº","å½©éŸ³","å¤§ç¿”","ç¾ç¾½","ç‘›å¤ª","çœŸå¤®","æ¥“çœŸ","ç™¾èŠ±","ä»","ç¾å„ª","å¹¹å¤ª","é™½å‘","èœæœˆ","éš¼","å„ªèœ","æ­©å¤¢","å„ªè¡£","æ‚ å¸Œ","ã“ã“ã‚","é™½æ–—","è‰å­","é›ªä¹ƒ","å¤ªé™½","ç²å¥ˆ","é›…","æ¨¹","æ¹Š","ä¼Šç¹”","å‡œ","è˜­","å³äº¬","åƒå°‹","é™¸","æ¥“","ä¸ƒæµ·","è“®","è–«","çœŸç†å­","ç›´äºº","é‡Œå¥ˆ","ç¿¼","èŒœ","ç¶¾ä¹ƒ","ã‚·ãƒ£ãƒ¼ãƒ­ãƒƒã‚¯","ã‚¸ãƒ§ãƒ³","ã‚¢ã‚¤ãƒªãƒ¼ãƒ³","ãƒ¡ãƒªãƒ¼"];

const aliasSeeds = ["å¥½ããªé…’ã®åå‰","å¥½ããªè‰²ã®åå‰","å¥½ããªå‹•ç‰©ã®åå‰","å¥½ããªæƒ‘æ˜Ÿã®åå‰","å¥½ããªæ˜ ç”»ã®åå‰","å¥½ããªãŠè“å­ã®åå‰","å¥½ããªå°èª¬ã®åå‰","å¥½ããªæ˜Ÿåº§ã®åå‰","å¥½ããªä½œå®¶ã®åå‰","å¥½ããªåˆƒç‰©ã®åå‰","å¥½ããªéŠƒå™¨ã®åå‰","æ¥ã¦ã„ã‚‹ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã®åå‰","ä»˜ã‘ã¦ã„ã‚‹ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®åå‰","å¥½ããªæ–™ç†ã®åå‰","ãŸã ã®é€šã‚Šã™ãŒã‚Š","ç•ªå·ã§å‘¼ã°ã‚Œã¦ã„ã‚‹","æ¢åµ","åŠ©æ‰‹","ã‚¢ãƒ³ãƒã‚¦ãƒ³","é€šç§°ã€ä¾¿åˆ©å±‹ã€","ä¸æ˜"];

const heightTable = ["éå¸¸ã«é«˜ã„","é«˜ã‚","å¹³å‡çš„","ä½ã‚","éå¸¸ã«ä½ã„","ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚ˆã‚Šå°‘ã—é«˜ã„","ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚ˆã‚Šå°‘ã—ä½ã„"];
const fashionTable = ["é«˜ç´šå¿—å‘","ã‚¹ãƒ¼ãƒ„","ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¦ã‚§ã‚¢","ãƒ•ã‚©ãƒ¼ãƒãƒ«ã‚¦ã‚§ã‚¢","ã‚¹ãƒãƒ¼ãƒ„ã‚¦ã‚§ã‚¢","ãƒªãƒ¼ã‚ºãƒŠãƒ–ãƒ«","ã‚µãƒ³ã‚°ãƒ©ã‚¹","Yã‚·ãƒ£ãƒ„","Tã‚·ãƒ£ãƒ„","ãƒãƒƒã‚¯ãƒ¬ã‚¹","å¸½å­","ãƒŸãƒªã‚¿ãƒªãƒ¼é¢¨","ãƒ”ã‚¢ã‚¹","ã‚¸ãƒ£ãƒ¼ã‚¸","ã‚¨ã‚¯ã‚¹ãƒ†","å’Œé¢¨","æŒ‡è¼ª","ãƒãƒ§ãƒ¼ã‚«ãƒ¼","ã‚µãƒ³ãƒ€ãƒ«","ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼","ç™½è¡£","ã‚°ãƒ­ãƒ¼ãƒ–","ãƒ‘ã‚¤ãƒ—","å’Œæœ","ã‚«ãƒ©ãƒ•ãƒ«ãªè‰²ä½¿ã„","ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã«ã“ã ã‚ã‚ŠãŒãªã„"];
const likeDislikeTable = ["æ­»ä½“","çŠ¬","çŒ«","ã‚µã‚¹ãƒšãƒ³ã‚¹","ç‰©èª","ã‚¢ã‚¤ãƒ‰ãƒ«","çŠ¯ç½ª","ã‚ªã‚«ãƒ«ãƒˆ","å¥åº·","ã‚¸ãƒ£ãƒ³ã‚¯ãƒ•ãƒ¼ãƒ‰","é«˜ç´šãªé£Ÿäº‹","ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³","æ¨©åŠ›","åèª‰","å‹æƒ…","ãŠã‚„ã¤","åœ°å…ƒ","å®¶æ—","è­¦å¯Ÿ","éŸ³æ¥½","éŠƒ","è¬","æ¢åµ","ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼","ç‰¹ã«ãªã—","äººé–“","çŸ¥ã‚‰ãªã„ã“ã¨"];
const jobTable = ["ãƒ•ãƒªãƒ¼ã‚¿ãƒ¼","å­¦ç”Ÿï¼ˆå„ªç§€ï¼‰","å­¦ç”Ÿï¼ˆæ™®é€šï¼‰","å­¦ç”Ÿï¼ˆä¸çœŸé¢ç›®ï¼‰","æ•™å¸«ãƒ»è¬›å¸«","ä¼šç¤¾å“¡","ä¸»å¤«ãƒ»ä¸»å©¦","è‡ªå–¶æ¥­","ãƒ‡ã‚£ãƒ¬ãƒƒã‚¿ãƒ³ãƒˆ","åˆ‘äº‹ï¼ˆæ–°äººï¼‰","åˆ‘äº‹ï¼ˆã‚¨ãƒªãƒ¼ãƒˆï¼‰","å…¬å‹™å“¡","æ¢åµåŠ©æ‰‹","æ¢åµï¼ˆæœ‰åï¼‰","æ¢åµï¼ˆæ™®é€šï¼‰","æ¢åµï¼ˆä¸äººæ°—ï¼‰","ç„¡è·","ç ”ç©¶è€…","ä½œå®¶"];
const weirdHabits = ["å¦™ã§ã™ã­â€¦ã¨å¿…ãšè¨€ã†","å‹æ‰‹ã«é‘‘è­˜ã‚’å§‹ã‚ã‚‹","äº‹ä»¶ã®ç›¸é–¢å›³ã‚’å£ã«æ›¸ãå§‹ã‚ã‚‹","å¯é£Ÿã‚’å¿˜ã‚Œã¦æœæŸ»ã—ã¦å€’ã‚Œã‚‹","çªç„¶èµ°ã‚Šå‡ºã™","ã ã„ãŸã„ã‚ã‹ã‚Šã¾ã—ãŸâ€¦ã ã‘è¨€ã£ã¦é»™ã‚‹","çš®è‚‰ã°ã‹ã‚Šè¨€ã†","ç›¸æ‰‹ã®è¨€è‘‰ã‚’è‚¯å®šã—ã¦ã‹ã‚‰å¦å®šã™ã‚‹","åŠ©æ‰‹ã®è€³å…ƒã§æ€¥ã«å–‹ã‚‹","é¢¨å‘‚ã§è¬ãŒè§£ã‘ã‚‹"];
const guestRelations = ["æ˜”ã®ãƒãƒ‡ã‚£","å‹äºº","è¦ªå‹","é¡”è¦‹çŸ¥ã‚Š","æˆ¦å‹","è…ã‚Œç¸","å¹¼é¦´æŸ“","é ã„è¦ªæˆš","è¿‘æ‰€ã®äºº","å¸«åŒ ","å¶ç„¶çŸ¥ã‚Šåˆã£ãŸ","å‰ã«ä¸€åº¦ã ã‘ä¼šã£ãŸ","ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’è¿½ã£ã¦ã„ã‚‹"];
const guestNameSeeds = ["å°å³¶","æ˜Ÿé‡","æ±é›²","å¤©é‡","æ¦æœ¬","å®‡ç”°å·","è¥¿å±±","é³³","å²¡","é–¢"];

const backgroundsDetective = {
  blood: ["åæ¢åµã®å…ˆç¥–ï¼ˆçœŸï¼‰","åæ¢åµã®å…ˆç¥–ï¼ˆæƒ³ï¼‰","è¦ªãŒä¸–ç•Œçš„æ¢åµ","è¡—ã®åæ¢åµ","æ¨ç†ä½œå®¶","å •ã¡ãŸåæ¢åµ","å¤§æ‚ªäººã®è¡€","éš ã•ã‚ŒãŸè¡€ç­‹","ã‚¯ãƒ­ãƒ¼ãƒ³"],
  talent:["è¶…ã‚¨ãƒªãƒ¼ãƒˆ","ç¬é–“è¨˜æ†¶èƒ½åŠ›","çŸ¥è­˜ã®æ³‰","ã‚¹ãƒ‘ãƒ«ã‚¿æ•™è‚²","æ—¢ã«åæ¢åµ","æ†§ã‚Œã®èƒŒä¸­","ãƒ©ã‚¤ãƒãƒ«","å­¤ç«‹ã—ãŸåæ¢åµ","äººå·¥åæ¢åµ"],
  mania: ["ã‚µã‚¹ãƒšãƒ³ã‚¹ãƒãƒ‹ã‚¢","æ­»ä½“ãƒãƒ‹ã‚¢","ç§‘å­¦ãƒãƒ‹ã‚¢","ã„ã‚ã‚†ã‚‹ã‚ªã‚¿ã‚¯","äººé–“ãƒãƒ‹ã‚¢","æ›¸ç‰©ãƒãƒ‹ã‚¢","ã‚ªã‚«ãƒ«ãƒˆãƒãƒ‹ã‚¢","æ¢åµãƒãƒ‹ã‚¢","æš´èµ°ã™ã‚‹çŸ¥è­˜æ¬²"]
};
const backgroundsAssistant = {
  justice:["ãŠäººã‚ˆã—","è¨±ã›ãªã„","ç´å¾—ã—ãŸã„","åˆ©ç”¨ã—ã¦ã„ã‚‹","é ¼ã‚Œã‚‹å”åŠ›è€…","æ­£ç¾©ã®åŒå¿—"],
  passion:["èƒ½åŠ›ã«ã»ã‚Œè¾¼ã‚“ã ","äººæŸ„ã«ã»ã‚Œè¾¼ã‚“ã ","ä¸€ç›®æƒšã‚Œ","ã‚¦ãƒãŒåˆã£ãŸ","å¯¾ç«‹","æ”¾ã£ã¦ãŠã‘ãªã„"],
  involved:["ä¸€æ–¹çš„ã«æ°—ã«å…¥ã‚‰ã‚ŒãŸ","ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¦å“¡","éå»ã®ãƒ„ã‚±","å¿…è¦ãªäººæ","è¦ªã—ã„äºº","å¶ç„¶ã®ç©ã¿é‡ã­"]
};

const catOrder = ["insight","forensic","human","body"];
const catLabels = { insight:"æ´å¯Ÿ", forensic:"é‘‘è­˜", human:"äººé–“", body:"è‚‰ä½“", any:"è‡ªç”±" };
const skillsByCat = {
  insight: ["å˜˜","å¤‰åŒ–","å¤–è¦‹","ç‰©ç†","ç¾å ´","å¤©æ°—"],
  forensic:["äº¤é€š","æƒ…å ±","æŒ‡ç´‹","ç§‘å­¦","æ³•åŒ»å­¦","ç”Ÿç‰©"],
  human:   ["ç¤¾äº¤","å®¶äº‹","å™‚è©±","èª¬å¾—","æµè¡Œ","ãƒ“ã‚¸ãƒã‚¹"],
  body:    ["æ•ç¸›","é˜²å¾¡","æ ¹æ€§","ä½“åŠ›","çªç ´","è¿½è·¡"]
};
const allSkillKeys = Object.values(skillsByCat).flat();

const rules = {
  detective: {
    blood:  { label:"æ¢åµï¼šé‹å‘½ã®è¡€çµ±", fixed: [], slots: [{cat:"insight",n:2},{cat:"forensic",n:2},{cat:"any",n:2}] },
    talent: { label:"æ¢åµï¼šå¤©æ€§ã®æ‰èƒ½", fixed: [], slots: [{cat:"insight",n:2},{cat:"forensic",n:3},{cat:"any",n:1}] },
    mania:  { label:"æ¢åµï¼šãƒãƒ‹ã‚¢",     fixed: [], slots: [{cat:"insight",n:2},{cat:"forensic",n:2},{cat:"human",n:1},{cat:"any",n:1}] }
  },
  assistant: {
    justice: { label:"åŠ©æ‰‹ï¼šæ­£ç¾©ã®äºº", fixed:["èª¬å¾—","çªç ´"], slots: [{cat:"human",n:2},{cat:"any",n:1}] },
    passion: { label:"åŠ©æ‰‹ï¼šæƒ…ç†±ã®äºº", fixed:["ç¤¾äº¤","æ ¹æ€§"], slots: [{cat:"human",n:2},{cat:"any",n:1}] },
    involved:{ label:"åŠ©æ‰‹ï¼šå·»ãè¾¼ã¾ã‚Œã®äºº", fixed:["é˜²å¾¡"], slots: [{cat:"human",n:2},{cat:"body",n:2}] }
  }
};

const actionTexts = {
  baseDetective: { name:"ãƒ•ã‚¿ãƒªã‚½ã‚¦ã‚µ", type:"è£œåŠ©", cost:"ãªã—",
    text:"æœæŸ»ãƒ•ã‚§ã‚¤ã‚ºã®ã‚·ãƒ¼ãƒ³çµ‚äº†æ™‚ã«ä½¿ç”¨ã€‚äº’ã„ã¸ã®æ„Ÿæƒ…ã‚’1ã¤å¼·ã„æ„Ÿæƒ…ã«ã™ã‚‹ã“ã¨ã§æ¬¡ã®ã‚·ãƒ¼ãƒ³ã‚’ã€Œãƒ•ã‚¿ãƒªã‚½ã‚¦ã‚µã‚·ãƒ¼ãƒ³ã€ã«å¤‰æ›´ã§ãã‚‹ã€‚" },
  baseAssistant: { name:"é£Ÿã‚‰ã„ã¤ã", type:"è£œåŠ©", cost:"1",
    text:"åˆ¤å®šå¾Œã«ä½¿ç”¨ã€‚æ„Ÿæƒ…ã‚’1ã¤å¼·ã„æ„Ÿæƒ…ã«ã™ã‚‹ã“ã¨ã§ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚Šç›´ã›ã‚‹ï¼ˆåé¢ä½“ã«ã§ãã‚‹ï¼‰ã€‚" },
  detective: {
    blood:  { name:"è¡€ã®ç›´æ„Ÿ", type:"è£œåŠ©", cost:"1", text:"åˆ¤å®šå¾Œã«ä½¿ç”¨ã€‚åˆ¤å®šã‚µã‚¤ã‚³ãƒ­ã®ç›®ã‚’ã™ã¹ã¦4ã«å¤‰æ›´ã§ãã‚‹ã€‚" },
    talent: { name:"å½“ç„¶çŸ¥ã£ã¦ã„ã‚‹", type:"è£œåŠ©", cost:"ãªã—", text:"ã„ã¤ã§ã‚‚ä½¿ç”¨ã€‚å¥½ããªæŠ€èƒ½ã‚’1ã¤ä¿®å¾—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«å¤±ã†ï¼‰ã€‚1ã‚»ãƒƒã‚·ãƒ§ãƒ³2å›ã¾ã§ã€‚" },
    mania:  { name:"è†¨å¤§ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹", type:"è£œåŠ©", cost:"2", text:"é‡è¦ã§ãªã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç²å¾—æ™‚ã«ä½¿ç”¨ã€‚ã•ã‚‰ã«é‡è¦ã§ãªã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’1ã¤ç²å¾—ã€‚1ã‚»ãƒƒã‚·ãƒ§ãƒ³1å›ã¾ã§ã€‚" }
  },
  assistant: {
    justice: { name:"æ°—åˆã‚’å…¥ã‚Œã‚‹", type:"å¸¸é§", cost:"ãªã—", text:"åˆå‹•æœæŸ»ã®åˆ¤å®šã‚’è¡Œã†ã¨ãã€æœ‰åˆ©ã‚’å¾—ã‚‹ã€‚" },
    passion: { name:"è¦‹ç›´ã™", type:"è£œåŠ©", cost:"ãªã—", text:"æœæŸ»ä¸­ã€æ¢åµã®åˆ¤å®šã«4ä»¥ä¸ŠãŒã‚ã£ãŸå ´åˆã€æ„Ÿæƒ…ã‚’1ã¤ç²å¾—ã€‚1ã‚»ãƒƒã‚·ãƒ§ãƒ³1å›ã¾ã§ã€‚" },
    involved:{ name:"ã“ã†ãªã‚‹ã¨ã‚ã‹ã£ã¦ãŸ", type:"å¸¸é§", cost:"ãªã—", text:"ãŸã¾ã‚Šå ´ãƒ•ã‚§ã‚¤ã‚ºã§ä½™è£•ç²å¾—ã‚’è¡Œã†ã¨ãã€ç²å¾—ã§ãã‚‹ä½™è£•ãŒ1ç‚¹ä¸Šæ˜‡ã€‚" }
  }
};

/** ===================== çŠ¶æ…‹ï¼ˆç·¨é›†ä¸­ã®1ã‚­ãƒ£ãƒ©ï¼‰ ===================== **/
let state = makeEmptyState();
let selectedId = ""; // ä¿å­˜æ¸ˆã¿ã‚­ãƒ£ãƒ©ã®é¸æŠIDï¼ˆæœªä¿å­˜ãªã‚‰ç©ºï¼‰

function makeEmptyState(){
  return {
    role: "detective",
    dclass: "blood",
    aclass: "justice",
    // fields
    name:"", alias:"", age:"", height:"", fashion:"", job:"", like:"", dislike:"",
    weirdHabit:"", memo:"",
    background:"",
    guestName:"", guestSkill:"", guestRelation:"",
    partnerName:"", partnerCall:"", partnerLike:"", partnerDislike:"",
    // skills
    slotSelections: [] // {type:"single"/"any", cat:"", value:""}
  };
}

/** ===================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===================== **/
const $ = (id) => document.getElementById(id);
const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
function catLabel(cat){ return catLabels[cat] || cat; }
function uniqShuffle(arr){
  const a = [...arr];
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function makeAlias(){
  const seed = rand(aliasSeeds);
  return seed.startsWith("é€šç§°") ? seed : `ï¼ˆ${seed}ï¼‰`;
}
function safeNameForList(s){
  const n = (s.name||"").trim();
  if (n) return n;
  return (s.role==="detective" ? "æ¢åµ" : "åŠ©æ‰‹") + "ï¼ˆç„¡åï¼‰";
}

/** ===================== UI åˆæœŸåŒ– ===================== **/
function initSelect(id, list, placeholder="é¸æŠã—ã¦ãã ã•ã„") {
  const sel = $(id);
  sel.innerHTML = "";
  const op0 = document.createElement("option");
  op0.value = "";
  op0.textContent = placeholder;
  sel.appendChild(op0);
  for (const v of list) {
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    sel.appendChild(op);
  }
}
function fillSelectDynamic(sel, list, selectedValue, placeholder){
  sel.innerHTML = "";
  const op0 = document.createElement("option");
  op0.value = "";
  op0.textContent = placeholder;
  sel.appendChild(op0);
  for (const item of list){
    const v = (typeof item==="string") ? item : item.value;
    const label = (typeof item==="string") ? item : item.label;
    const op = document.createElement("option");
    op.value = v;
    op.textContent = label;
    sel.appendChild(op);
  }
  sel.value = selectedValue || "";
}

function init(){
  initSelect("height", heightTable, "èº«é•·ï¼ˆè¡¨ï¼‰ã‚’é¸æŠ");
  initSelect("guestSkill", allSkillKeys, "æŠ€èƒ½ã‚’é¸æŠ");

  // load UI prefs
  const ui = loadUI();
  $("autoSave").checked = ui.autoSave;

  // role/class listeners
  document.querySelectorAll('input[name="role"]').forEach(r=>r.addEventListener("change",(e)=>{
    state.role = e.target.value;
    // role å¤‰æ›´ã¯ã‚¯ãƒ©ã‚¹è¡¨ç¤ºã‚„ã‚¹ãƒ­ãƒƒãƒˆãŒå¤‰ã‚ã‚‹ãŸã‚ã‚¹ãƒ­ãƒƒãƒˆå†æ§‹ç¯‰
    resetSlots();
    renderAll();
    markDirty();
  }));
  document.querySelectorAll('input[name="dclass"]').forEach(r=>r.addEventListener("change",(e)=>{
    state.dclass = e.target.value;
    resetSlots(); renderAll(); markDirty();
  }));
  document.querySelectorAll('input[name="aclass"]').forEach(r=>r.addEventListener("change",(e)=>{
    state.aclass = e.target.value;
    resetSlots(); renderAll(); markDirty();
  }));

  // per-field random buttons
  $("randName").addEventListener("click", ()=>{ $("name").value = `${rand(lastNames)} ${rand(firstNames)}`; syncFromForm(); });
  $("randAlias").addEventListener("click", ()=>{ $("alias").value = makeAlias(); syncFromForm(); });
  $("randAge").addEventListener("click", ()=>{ $("age").value = String(12 + Math.floor(Math.random()*49)); syncFromForm(); });
  $("randHeight").addEventListener("click", ()=>{ $("height").value = rand(heightTable); syncFromForm(); });
  $("randFashion").addEventListener("click", ()=>{ $("fashion").value = rand(fashionTable); syncFromForm(); });
  $("randJob").addEventListener("click", ()=>{ $("job").value = rand(jobTable); syncFromForm(); });
  $("randLike").addEventListener("click", ()=>{ $("like").value = rand(likeDislikeTable); syncFromForm(); });
  $("randDislike").addEventListener("click", ()=>{
    let d = rand(likeDislikeTable);
    if (d === $("like").value) d = rand(likeDislikeTable);
    $("dislike").value = d; syncFromForm();
  });
  $("randWeird").addEventListener("click", ()=>{ $("weirdHabit").value = rand(weirdHabits); syncFromForm(); });
  $("randBackground").addEventListener("click", ()=>{ randomBackgroundOnly(); syncFromForm(); });

  $("randGuestName").addEventListener("click", ()=>{ $("guestName").value = `${rand(guestNameSeeds)} ${rand(firstNames)}`; syncFromForm(); });
  $("randGuestSkill").addEventListener("click", ()=>{ $("guestSkill").value = rand(allSkillKeys); syncFromForm(); });
  $("randGuestRelation").addEventListener("click", ()=>{ $("guestRelation").value = rand(guestRelations); syncFromForm(); });

  // skills buttons
  $("btnResetSkills").addEventListener("click", ()=>{
    resetSlots(); renderSlots(); syncFromForm();
  });
  $("btnRandomSkills").addEventListener("click", ()=>{
    fillSlotsRandomly(); renderSlots(); syncFromForm();
  });

  // copy
  $("btnCopy").addEventListener("click", async ()=>{
    try { await navigator.clipboard.writeText($("preview").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"); }
    catch { alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚"); }
  });

  // autosave toggle
  $("autoSave").addEventListener("change", ()=>{
    const ui2 = loadUI();
    ui2.autoSave = $("autoSave").checked;
    saveUI(ui2);
    setStatus(`çŠ¶æ…‹ï¼š${$("autoSave").checked ? "è‡ªå‹•ä¿å­˜ON" : "è‡ªå‹•ä¿å­˜OFF"}`);
  });

  // Save / Switch UI
  $("btnNew").addEventListener("click", ()=>{
    if (!confirmDirtyOkay()) return;
    selectedId = "";
    state = makeEmptyState();
    resetSlots();
    renderAll();
    setStatus("çŠ¶æ…‹ï¼šæ–°è¦ï¼ˆæœªä¿å­˜ï¼‰");
    updateSaveMeta();
    renderCharList();
  });

  $("btnSaveAs").addEventListener("click", ()=>{
    const db = loadDB();
    const id = newId();
    const item = {
      id,
      name: safeNameForList(state),
      createdAt: nowIso(),
      updatedAt: nowIso(),
      data: structuredCloneSafe(state)
    };
    db.unshift(item);
    saveDB(db);
    selectedId = id;
    setStatus("çŠ¶æ…‹ï¼šæ–°è¦ä¿å­˜ã—ã¾ã—ãŸ");
    const ui2 = loadUI(); ui2.lastSelectedId = selectedId; saveUI(ui2);
    renderCharList();
    updateSaveMeta();
  });

  $("btnSave").addEventListener("click", ()=>{
    if (!selectedId){
      alert("ã¾ã ä¿å­˜å…ˆãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œæ–°è¦ã¨ã—ã¦ä¿å­˜ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚");
      return;
    }
    saveOverwrite(selectedId);
  });

  $("btnDelete").addEventListener("click", ()=>{
    if (!selectedId){ alert("å‰Šé™¤ã™ã‚‹ä¿å­˜æ¸ˆã¿ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"); return; }
    if (!confirm("ã“ã®ã‚­ãƒ£ãƒ©ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    const db = loadDB().filter(x=>x.id!==selectedId);
    saveDB(db);
    selectedId = "";
    setStatus("çŠ¶æ…‹ï¼šå‰Šé™¤ã—ã¾ã—ãŸï¼ˆæ–°è¦ã«æˆ»ã‚Šã¾ã—ãŸï¼‰");
    state = makeEmptyState();
    resetSlots();
    renderAll();
    renderCharList();
    updateSaveMeta();
  });

  $("charSelect").addEventListener("change", (e)=>{
    const id = e.target.value;
    if (id === "__new__"){
      $("btnNew").click();
      return;
    }
    if (!confirmDirtyOkay()) {
      // revert selection UI
      renderCharList();
      return;
    }
    if (!id) return;
    const db = loadDB();
    const item = db.find(x=>x.id===id);
    if (!item) return;
    selectedId = id;
    state = mergeState(item.data);
    // slot rebuild if missing
    ensureSlotsForRule();
    renderAll();
    setStatus("çŠ¶æ…‹ï¼šèª­ã¿è¾¼ã¿ã¾ã—ãŸ");
    const ui2 = loadUI(); ui2.lastSelectedId = selectedId; saveUI(ui2);
    updateSaveMeta();
  });

  $("btnExportOne").addEventListener("click", ()=>{
    const payload = selectedId
      ? { version:1, exportedAt: nowIso(), items: [getSelectedItemFromDB(selectedId) || makeExportItemFromState()] }
      : { version:1, exportedAt: nowIso(), items: [makeExportItemFromState()] };
    downloadJson(`futarisousa_char_${new Date().toISOString().slice(0,10)}.json`, payload);
  });

  $("btnExportAll").addEventListener("click", ()=>{
    const db = loadDB();
    const payload = { version:1, exportedAt: nowIso(), items: db };
    downloadJson(`futarisousa_chars_${new Date().toISOString().slice(0,10)}.json`, payload);
  });

  $("btnImport").addEventListener("click", ()=> $("importFile").click());
  $("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const json = JSON.parse(text);
      const items = Array.isArray(json.items) ? json.items : Array.isArray(json) ? json : null;
      if (!items) throw new Error("å½¢å¼ãŒä¸æ­£ã§ã™");
      const db = loadDB();
      // merge: idãŒè¢«ã£ãŸã‚‰æ–°IDã«ã—ã¦è¿½åŠ 
      const existingIds = new Set(db.map(x=>x.id));
      for (const it of items){
        if (!it || typeof it !== "object") continue;
        const data = it.data || it; // æ—§å½¢å¼æ•‘æ¸ˆ
        const base = {
          id: it.id && !existingIds.has(it.id) ? it.id : newId(),
          name: it.name || safeNameForList(data),
          createdAt: it.createdAt || nowIso(),
          updatedAt: it.updatedAt || nowIso(),
          data: mergeState(data)
        };
        existingIds.add(base.id);
        db.unshift(base);
      }
      saveDB(db);
      setStatus("çŠ¶æ…‹ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
      renderCharList();
      updateSaveMeta();
    } catch(err){
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼šJSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    } finally {
      e.target.value = "";
    }
  });

  // auto preview update + dirty tracking
  const autoIds = ["name","alias","age","height","fashion","job","like","dislike","background","weirdHabit","memo","guestName","guestSkill","guestRelation","partnerName","partnerCall","partnerLike","partnerDislike"];
  autoIds.forEach(id=>{
    const el = $(id);
    if (!el) return;
    el.addEventListener("input", ()=> syncFromForm());
    el.addEventListener("change", ()=> syncFromForm());
  });

  // first render: load last selected
  resetSlots();
  renderAll();

  renderCharList();
  const db = loadDB();
  const ui3 = loadUI();
  if (ui3.lastSelectedId && db.some(x=>x.id===ui3.lastSelectedId)){
    $("charSelect").value = ui3.lastSelectedId;
    $("charSelect").dispatchEvent(new Event("change"));
  } else {
    setStatus("çŠ¶æ…‹ï¼šæ–°è¦ï¼ˆæœªä¿å­˜ï¼‰");
    updateSaveMeta();
  }
}

/** ===================== ä¿å­˜é–¢é€£ helper ===================== **/
let dirty = false;

function setStatus(text){ $("status").textContent = text; }
function markDirty(){
  dirty = true;
  if ($("autoSave").checked && selectedId){
    // è‡ªå‹•ä¿å­˜ï¼ˆãŸã ã—ä¿å­˜æ¸ˆã¿ã‚­ãƒ£ãƒ©ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã¨ãã ã‘ï¼‰
    saveOverwrite(selectedId, true);
  } else {
    setStatus(selectedId ? "çŠ¶æ…‹ï¼šæœªä¿å­˜ã®å¤‰æ›´ã‚ã‚Š" : "çŠ¶æ…‹ï¼šæ–°è¦ï¼ˆæœªä¿å­˜ï¼‰");
  }
}
function clearDirty(){
  dirty = false;
  setStatus(selectedId ? "çŠ¶æ…‹ï¼šä¿å­˜æ¸ˆã¿" : "çŠ¶æ…‹ï¼šæ–°è¦ï¼ˆæœªä¿å­˜ï¼‰");
}
function confirmDirtyOkay(){
  if (!dirty) return true;
  return confirm("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨å¤±ã‚ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ");
}

function structuredCloneSafe(obj){
  // iOS Safariã®äº’æ›ã®ãŸã‚ã€JSONçµŒç”±ã§ã‚³ãƒ”ãƒ¼
  return JSON.parse(JSON.stringify(obj));
}

function saveOverwrite(id, silent=false){
  const db = loadDB();
  const idx = db.findIndex(x=>x.id===id);
  if (idx<0){ if(!silent) alert("ä¿å­˜å…ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); return; }
  db[idx].data = structuredCloneSafe(state);
  db[idx].name = safeNameForList(state);
  db[idx].updatedAt = nowIso();
  saveDB(db);
  renderCharList(); // è¡¨ç¤ºåæ›´æ–°
  updateSaveMeta();
  clearDirty();
  if (!silent) setStatus("çŠ¶æ…‹ï¼šä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ");
}

function getSelectedItemFromDB(id){
  const db = loadDB();
  return db.find(x=>x.id===id) || null;
}
function makeExportItemFromState(){
  return {
    id: newId(),
    name: safeNameForList(state),
    createdAt: nowIso(),
    updatedAt: nowIso(),
    data: structuredCloneSafe(state)
  };
}

function updateSaveMeta(){
  if (!selectedId){
    $("saveMeta").textContent = "æœªä¿å­˜ï¼ˆæ–°è¦ä½œæˆä¸­ï¼‰";
    return;
  }
  const it = getSelectedItemFromDB(selectedId);
  if (!it){ $("saveMeta").textContent = "ä¿å­˜æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; return; }
  const d = new Date(it.updatedAt);
  $("saveMeta").textContent = `ID: ${it.id} / æœ€çµ‚æ›´æ–°: ${d.toLocaleString()}`;
}

function renderCharList(){
  const db = loadDB();
  const sel = $("charSelect");
  sel.innerHTML = "";
  const opNew = document.createElement("option");
  opNew.value = "__new__";
  opNew.textContent = "ï¼‹ æ–°è¦ä½œæˆï¼ˆæœªä¿å­˜ï¼‰";
  sel.appendChild(opNew);

  const opSep = document.createElement("option");
  opSep.disabled = true;
  opSep.textContent = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€";
  sel.appendChild(opSep);

  for (const item of db){
    const op = document.createElement("option");
    op.value = item.id;
    const role = item.data?.role === "assistant" ? "åŠ©æ‰‹" : "æ¢åµ";
    op.textContent = `${item.name}ï¼ˆ${role}ï¼‰`;
    sel.appendChild(op);
  }

  if (selectedId && db.some(x=>x.id===selectedId)) sel.value = selectedId;
  else sel.value = "__new__";
}

/** ===================== ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿â‡„ãƒ•ã‚©ãƒ¼ãƒ åŒæœŸ ===================== **/
function syncToForm(){
  // role/class radios
  document.querySelector(`input[name="role"][value="${state.role}"]`).checked = true;
  document.querySelector(`input[name="dclass"][value="${state.dclass}"]`).checked = true;
  document.querySelector(`input[name="aclass"][value="${state.aclass}"]`).checked = true;

  // fields
  $("name").value = state.name || "";
  $("alias").value = state.alias || "";
  $("age").value = state.age || "";
  $("height").value = state.height || "";
  $("fashion").value = state.fashion || "";
  $("job").value = state.job || "";
  $("like").value = state.like || "";
  $("dislike").value = state.dislike || "";
  $("weirdHabit").value = state.weirdHabit || "";
  $("memo").value = state.memo || "";
  // background list depends on class
  renderBackgroundList();
  $("background").value = state.background || "";

  $("guestName").value = state.guestName || "";
  $("guestSkill").value = state.guestSkill || "";
  $("guestRelation").value = state.guestRelation || "";

  $("partnerName").value = state.partnerName || "";
  $("partnerCall").value = state.partnerCall || "";
  $("partnerLike").value = state.partnerLike || "";
  $("partnerDislike").value = state.partnerDislike || "";
}

function syncFromForm(){
  state.name = $("name").value;
  state.alias = $("alias").value;
  state.age = $("age").value;
  state.height = $("height").value;
  state.fashion = $("fashion").value;
  state.job = $("job").value;
  state.like = $("like").value;
  state.dislike = $("dislike").value;
  state.weirdHabit = $("weirdHabit").value;
  state.memo = $("memo").value;
  state.background = $("background").value;

  state.guestName = $("guestName").value;
  state.guestSkill = $("guestSkill").value;
  state.guestRelation = $("guestRelation").value;

  state.partnerName = $("partnerName").value;
  state.partnerCall = $("partnerCall").value;
  state.partnerLike = $("partnerLike").value;
  state.partnerDislike = $("partnerDislike").value;

  updatePreview();
  markDirty();
  // ä¿å­˜ä¸€è¦§ã«è¡¨ç¤ºåã‚’åæ˜ ã—ãŸã„ï¼ˆæœªä¿å­˜ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼‰
  if (selectedId) renderCharList();
}

/** ===================== ãƒ«ãƒ¼ãƒ«/æç”» ===================== **/
function getCurrentClassKey() { return state.role === "detective" ? state.dclass : state.aclass; }
function getCurrentRule() { return rules[state.role][getCurrentClassKey()]; }

function renderAll(){
  const isD = state.role === "detective";
  $("detectiveClassBox").classList.toggle("hide", !isD);
  $("assistantClassBox").classList.toggle("hide", isD);
  $("assistantMental").classList.toggle("hide", isD);
  $("guestBox").classList.toggle("hide", isD);
  $("detectiveOnlyBasics").classList.toggle("hide", !isD);

  renderRulePill();
  renderBackgroundList();
  renderFixedSkills();
  renderActions();
  ensureSlotsForRule();
  renderSlots();
  syncToForm();
  updatePreview();
}

function renderRulePill(){ $("rulePill").textContent = `æŠ€èƒ½ãƒ«ãƒ¼ãƒ«ï¼š${getCurrentRule().label}`; }

function renderBackgroundList(){
  const key = getCurrentClassKey();
  const list = (state.role==="detective") ? backgroundsDetective[key] : backgroundsAssistant[key];
  const sel = $("background");
  sel.innerHTML = "";
  const op0 = document.createElement("option");
  op0.value = "";
  op0.textContent = "èƒŒæ™¯ã‚’é¸æŠï¼ˆã‚¯ãƒ©ã‚¹é€£å‹•ï¼‰";
  sel.appendChild(op0);
  list.forEach(v=>{
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    sel.appendChild(op);
  });
}

function randomBackgroundOnly(){
  const key = getCurrentClassKey();
  const list = (state.role==="detective") ? backgroundsDetective[key] : backgroundsAssistant[key];
  $("background").value = rand(list);
}

function renderFixedSkills(){
  const fixed = getCurrentRule().fixed || [];
  $("fixedSkillsBox").innerHTML = fixed.length
    ? fixed.map(s=>`<span class="tag">${s}</span>`).join(" ")
    : `<span class="muted">ãªã—</span>`;
}

function renderActions(){
  const isD = state.role==="detective";
  const key = getCurrentClassKey();
  const base = isD ? actionTexts.baseDetective : actionTexts.baseAssistant;
  const extra = isD ? actionTexts.detective[key] : actionTexts.assistant[key];
  $("actionsBox").innerHTML = `
    <div class="a"><b>${base.name}</b> / ã‚¿ã‚¤ãƒ—ã€${base.type}ã€‘/ ã‚³ã‚¹ãƒˆã€${base.cost}ã€‘<br>${base.text}</div>
    <div class="a"><b>${extra.name}</b> / ã‚¿ã‚¤ãƒ—ã€${extra.type}ã€‘/ ã‚³ã‚¹ãƒˆã€${extra.cost}ã€‘<br>${extra.text}</div>
  `;
}

/** ===================== æŠ€èƒ½ã‚¹ãƒ­ãƒƒãƒˆ ===================== **/
function expandSlots(slotDefs){
  const out = [];
  for (const def of slotDefs){
    for (let i=0;i<def.n;i++){
      out.push({cat:def.cat, label:`${catLabel(def.cat)} ${i+1}`});
    }
  }
  return out;
}
function ensureSlotsForRule(){
  const slots = expandSlots(getCurrentRule().slots || []);
  if (!Array.isArray(state.slotSelections) || state.slotSelections.length !== slots.length){
    resetSlots();
  }
}
function resetSlots(){
  const slots = expandSlots(getCurrentRule().slots || []);
  state.slotSelections = slots.map(s=> s.cat==="any"
    ? {type:"any", cat:"", value:""}
    : {type:"single", cat:s.cat, value:""}
  );
}

function getUsedSkillSet(exceptSlotIndex=null){
  const fixed = new Set(getCurrentRule().fixed || []);
  const chosen = new Set();
  state.slotSelections.forEach((s,i)=>{
    if (exceptSlotIndex!==null && i===exceptSlotIndex) return;
    if (s.value) chosen.add(s.value);
  });
  return new Set([...fixed, ...chosen]);
}
function validateNoDuplicate(slotIndex, nextValue){
  if (!nextValue) return true;
  const used = getUsedSkillSet(slotIndex);
  return !used.has(nextValue);
}
function optionsForCat(cat, slotIndex){
  const fixed = new Set(getCurrentRule().fixed || []);
  const used = getUsedSkillSet(slotIndex);
  let pool = (skillsByCat[cat] || []).filter(s=>!fixed.has(s) && !used.has(s));
  const current = state.slotSelections[slotIndex].value;
  if (current && (skillsByCat[cat]||[]).includes(current)) {
    pool = [current, ...pool.filter(x=>x!==current)];
  }
  return pool;
}

function renderSlots(){
  const rule = getCurrentRule();
  const slotDefs = rule.slots || [];
  const slots = expandSlots(slotDefs);

  const fixed = rule.fixed || [];
  const slotSummary = slotDefs.map(d=>`${catLabel(d.cat)}Ã—${d.n}`).join("ï¼‹");
  $("skillsHelp").innerHTML = `ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ«ï¼š<b>${rule.label}</b><br>å›ºå®šæŠ€èƒ½ï¼š<b>${fixed.length?fixed.join("ã€"):"ãªã—"}</b><br>é¸æŠæ ï¼š<b>${slotSummary||"ãªã—"}</b>`;

  const box = $("slotsBox");
  box.innerHTML = "";
  const group = document.createElement("div");
  group.className = "slotGroup";
  group.innerHTML = `<h3>é¸ã¶æŠ€èƒ½ï¼ˆè‡ªç”±æ ã¯ã‚«ãƒ†ã‚´ãƒªâ†’æŠ€èƒ½ã®2æ®µï¼‰</h3>`;

  slots.forEach((slot,i)=>{
    const row = document.createElement("div");
    row.className = "slotRow";

    const left = document.createElement("div");
    left.innerHTML = `<span class="tag">${slot.label}</span>`;

    const right = document.createElement("div");

    if (slot.cat !== "any"){
      const sel = document.createElement("select");
      sel.dataset.slotIndex = String(i);
      fillSelectDynamic(sel, optionsForCat(slot.cat, i), state.slotSelections[i].value, "æŠ€èƒ½ã‚’é¸æŠ");
      sel.addEventListener("change",(e)=>{
        const idx = Number(e.target.dataset.slotIndex);
        const val = e.target.value;
        if (!validateNoDuplicate(idx, val)){
          e.target.value = state.slotSelections[idx].value || "";
          alert("åŒã˜æŠ€èƒ½ã¯é‡è¤‡å–å¾—ã§ãã¾ã›ã‚“ã€‚åˆ¥ã®æŠ€èƒ½ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
          return;
        }
        state.slotSelections[idx].value = val;
        renderSlots();
        updatePreview();
        markDirty();
      });
      right.appendChild(sel);
    } else {
      const wrap = document.createElement("div");
      wrap.className = "twoStage";

      const catSel = document.createElement("select");
      catSel.dataset.slotIndex = String(i);
      fillSelectDynamic(catSel, catOrder.map(c=>({value:c,label:catLabel(c)})), state.slotSelections[i].cat, "ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ");

      const skillSel = document.createElement("select");
      skillSel.dataset.slotIndex = String(i);
      const curCat = state.slotSelections[i].cat;
      const opts = curCat ? optionsForCat(curCat, i) : [];
      fillSelectDynamic(skillSel, opts, state.slotSelections[i].value, curCat ? "æŠ€èƒ½ã‚’é¸æŠ" : "å…ˆã«ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ");

      catSel.addEventListener("change",(e)=>{
        const idx = Number(e.target.dataset.slotIndex);
        state.slotSelections[idx].cat = e.target.value;
        state.slotSelections[idx].value = "";
        renderSlots();
        updatePreview();
        markDirty();
      });

      skillSel.addEventListener("change",(e)=>{
        const idx = Number(e.target.dataset.slotIndex);
        const val = e.target.value;
        if (!validateNoDuplicate(idx, val)){
          e.target.value = state.slotSelections[idx].value || "";
          alert("åŒã˜æŠ€èƒ½ã¯é‡è¤‡å–å¾—ã§ãã¾ã›ã‚“ã€‚åˆ¥ã®æŠ€èƒ½ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
          return;
        }
        state.slotSelections[idx].value = val;
        renderSlots();
        updatePreview();
        markDirty();
      });

      wrap.appendChild(catSel);
      wrap.appendChild(skillSel);
      right.appendChild(wrap);
    }

    row.appendChild(left);
    row.appendChild(right);
    group.appendChild(row);
  });

  box.appendChild(group);
}

function fillSlotsRandomly(){
  const rule = getCurrentRule();
  const slots = expandSlots(rule.slots || []);
  const fixedSet = new Set(rule.fixed || []);
  const used = new Set([...fixedSet]);

  state.slotSelections = slots.map(s=> s.cat==="any"
    ? {type:"any", cat:"", value:""}
    : {type:"single", cat:s.cat, value:""}
  );

  for (let i=0;i<slots.length;i++){
    const s = slots[i];
    if (s.cat !== "any"){
      const pool = (skillsByCat[s.cat]||[]).filter(x=>!used.has(x));
      const pick = pool.length ? rand(pool) : "";
      state.slotSelections[i].value = pick;
      if (pick) used.add(pick);
    } else {
      let chosenCat = "";
      for (const c of uniqShuffle(catOrder)){
        const pool = (skillsByCat[c]||[]).filter(x=>!used.has(x));
        if (pool.length){ chosenCat = c; break; }
      }
      state.slotSelections[i].cat = chosenCat;
      if (chosenCat){
        const pool = (skillsByCat[chosenCat]||[]).filter(x=>!used.has(x));
        const pick = pool.length ? rand(pool) : "";
        state.slotSelections[i].value = pick;
        if (pick) used.add(pick);
      }
    }
  }
}

/** ===================== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===================== **/
function getAllSkills(){
  const fixed = getCurrentRule().fixed || [];
  const chosen = (state.slotSelections||[]).map(s=>s.value).filter(Boolean);
  const seen = new Set();
  const out = [];
  for (const s of [...fixed, ...chosen]){
    if (!seen.has(s)){ seen.add(s); out.push(s); }
  }
  return out;
}
function updatePreview(){
  const role = state.role==="detective" ? "æ¢åµ" : "åŠ©æ‰‹";
  const key = getCurrentClassKey();
  const rule = getCurrentRule();
  const isD = state.role==="detective";
  const skills = getAllSkills();

  const base = isD ? actionTexts.baseDetective : actionTexts.baseAssistant;
  const extra = isD ? actionTexts.detective[key] : actionTexts.assistant[key];

  const lines = [];
  lines.push(`ã€ãƒ•ã‚¿ãƒªã‚½ã‚¦ã‚µ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€‘`);
  lines.push(`â–  ç¨®åˆ¥ï¼š${role}`);
  lines.push(`â–  ã‚¯ãƒ©ã‚¹ï¼š${rule.label}`);
  lines.push(`â–  åå‰ï¼š${(state.name||"").trim() || "ï¼ˆæœªå…¥åŠ›ï¼‰"}`);
  if ((state.alias||"").trim()) lines.push(`â–  å½åï¼š${state.alias.trim()}`);
  if ((state.age||"").toString().trim()) lines.push(`â–  å¹´é½¢ï¼š${state.age}`);
  if (state.height) lines.push(`â–  èº«é•·ï¼š${state.height}`);
  if ((state.fashion||"").trim()) lines.push(`â–  ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ï¼š${state.fashion.trim()}`);
  if ((state.job||"").trim()) lines.push(`â–  è·æ¥­ï¼š${state.job.trim()}`);
  if ((state.like||"").trim()) lines.push(`â–  å¥½ãï¼š${state.like.trim()}`);
  if ((state.dislike||"").trim()) lines.push(`â–  å«Œã„ï¼š${state.dislike.trim()}`);
  if (state.background) lines.push(`â–  èƒŒæ™¯ï¼š${state.background}`);
  if (isD && (state.weirdHabit||"").trim()) lines.push(`â–  ç•°å¸¸ãªç™–ï¼š${state.weirdHabit.trim()}`);

  lines.push(``);
  lines.push(`â–  æŠ€èƒ½ï¼š${skills.length ? skills.join("ã€") : "ï¼ˆæœªé¸æŠï¼‰"}`);

  lines.push(``);
  lines.push(`â–  ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š`);
  lines.push(`  ãƒ»${base.name}ï¼ˆ${base.type} / ã‚³ã‚¹ãƒˆ${base.cost}ï¼‰`);
  lines.push(`    ${base.text}`);
  lines.push(`  ãƒ»${extra.name}ï¼ˆ${extra.type} / ã‚³ã‚¹ãƒˆ${extra.cost}ï¼‰`);
  lines.push(`    ${extra.text}`);

  if (!isD){
    lines.push(``);
    lines.push(`â–  ãƒ¡ãƒ³ã‚¿ãƒ«ï¼šä½™è£•0 / å¿ƒåŠ´0ï¼ˆ3ã§ãƒ­ã‚¹ãƒˆï¼‰`);
    lines.push(``);
    lines.push(`â–  ã‚²ã‚¹ãƒˆï¼š`);
    lines.push(`  ãƒ»åå‰ï¼š${(state.guestName||"").trim() || "ï¼ˆæœªå…¥åŠ›ï¼‰"}`);
    lines.push(`  ãƒ»æŠ€èƒ½ï¼š${state.guestSkill || "ï¼ˆæœªé¸æŠï¼‰"}`);
    if ((state.guestRelation||"").trim()) lines.push(`  ãƒ»é–¢ä¿‚ï¼š${state.guestRelation.trim()}`);
  }

  const memo = (state.memo||"").trim();
  if (memo){
    lines.push(``);
    lines.push(`â–  ãƒ¡ãƒ¢ï¼š`);
    lines.push(memo);
  }

  $("preview").textContent = lines.join("\n");
}

/** ===================== ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®æ•´å½¢ ===================== **/
function mergeState(data){
  const base = makeEmptyState();
  if (!data || typeof data !== "object") return base;

  // æ—¢å­˜ã‚­ãƒ¼ã ã‘å–ã‚Šè¾¼ã¿
  for (const k of Object.keys(base)){
    if (k in data) base[k] = data[k];
  }
  // role/class ã®é˜²å¾¡
  base.role = (base.role==="assistant") ? "assistant" : "detective";
  base.dclass = ["blood","talent","mania"].includes(base.dclass) ? base.dclass : "blood";
  base.aclass = ["justice","passion","involved"].includes(base.aclass) ? base.aclass : "justice";

  // slotSelections ã®å½¢å¼é˜²å¾¡
  if (!Array.isArray(base.slotSelections)) base.slotSelections = [];
  return base;
}

/** ===================== èµ·å‹• ===================== **/
init();
</script>
</body>
</html>
